parameters:
- name: stage
- name: displayName
- name: environment
- name: microserviceName
- name: ingress
  default: 'internal'
- name: dependsOn
  default: Build

stages:
- stage: ${{stage}}
  displayName: ${{displayName}}
  dependsOn: ${{dependsOn}}
  jobs:
  - deployment: Deploy
    pool:
      vmImage: $(vmImageName)
    environment: ${{environment}}
    strategy:
      runOnce:
        deploy:
          steps:
          - task: AzureContainerApps@1
            inputs:
              azureSubscription: 'Azure subscription 1(ac6df0a6-4361-4fcc-b232-1c938d623a03)'
              imageToDeploy: 'transportacr.azurecr.io/${{microserviceName}}:$(Build.BuildId)'
              containerAppName: '${{microserviceName}}-container-app'
              resourceGroup: 'transport-microservices-rg'
              containerAppEnvironment: 'transport-microservices-env-prod' # TODO: This shouldn't have the prod environment in its name.
              targetPort: '8080'
              location: 'uksouth'
              ingress: ${{ingress}}
              acrName: 'transportacr'